!function(a,b){"function"==typeof define&&define.amd?define(b):"object"==typeof exports?module.exports=b():a.way=b()}(this,function(){"use strict";var a,b,c="way",d=function(){this._watchers={},this._watchersAll={}};d.prototype.constructor=d,d.prototype.watchAll=function(a){this._watchersAll=this._watchersAll||[],_.contains(this._watchersAll,a)||this._watchersAll.push(a)},d.prototype.watch=function(a,b){this._watchers||(this._watchers={}),this._watchers[a]=this._watchers[a]||[],this._watchers[a].push(b)},d.prototype.findWatcherDeps=function(a){var b=[],c=_.keys(this._watchers);return c.forEach(function(c){f(a,c)&&b.push(c)}),b},d.prototype.emitChange=function(a){this._watchers||(this._watchers={});var b=this,c=b.findWatcherDeps(a);c.forEach(function(a){this._watchers[a]&&this._watchers[a].forEach(function(c){c.apply(b,[b.get(a)])})}),b._watchersAll&&_.isArray(b._watchersAll)&&b._watchersAll.forEach(function(c){_.isFunction(c)&&c.apply(b,[a,b.get(a)])})};var e=function(){this.data={},this._bindings={},this.options={persistent:!0,timeoutInput:50,timeoutDOM:500}};e.prototype=Object.create(d.prototype),e.constructor=e,e.prototype.dom=function(a){return this._element=b.dom(a).get(0),this},e.prototype.toStorage=function(a,b){var c=this,b=b||c._element,a=a||c.dom(b).getOptions(),d=c.dom(b).toJSON(a),e=c.dom(b).scope(),f=e?e+"."+a.data:a.data;return a.readonly?!1:void c.set(f,d,a)},e.prototype.toJSON=function(a,b){var c=this,b=b||c._element,d=c.dom(b).getValue(),a=a||c.dom(b).getOptions();return _.isArray(a.pick)&&(d=j(d,a.pick,!0)),_.isArray(a.omit)&&(d=j(d,a.omit,!1)),d},e.prototype.fromStorage=function(a,b){var c=this,b=b||c._element,a=a||c.dom(b).getOptions();if(a.writeonly)return!1;var d=c.dom(b).scope(),e=d?d+"."+a.data:a.data,f=c.get(e);c.dom(b).fromJSON(f,a)},e.prototype.fromJSON=function(a,b,c){var d=this,c=c||d._element,b=b||d.dom(c).getOptions();if(b.writeonly)return!1;if(_.isObject(a)){_.isArray(b.pick)&&(a=j(a,b.pick,!0)),_.isArray(b.omit)&&(a=j(a,b.omit,!1));var e=_.isObject(d.dom(c).toJSON())?d.dom(c).toJSON():{};a=_.extend(e,a)}b.json&&(a=_json.isStringified(a)?a:_json.prettyprint(a)),d.dom(c).setValue(a,b)},e.prototype.getValue=function(a){var c=this,a=a||c._element,d={SELECT:function(){return b.dom(a).val()},INPUT:function(){var c=b.dom(a).type();return _.contains(["text","password"],c)?b.dom(a).val():_.contains(["checkbox","radio"],c)?b.dom(a).prop("checked")?b.dom(a).val():null:void 0},TEXTAREA:function(){return b.dom(a).val()}},e=function(){b.dom(a).html()},f=b.dom(a).get(0).tagName,g=d[f]||e;return g()},e.prototype.setValue=function(a,c,d){var e=this,d=d||e._element,c=c||e.dom(d).getOptions(),f={SELECT:function(a){b.dom(d).val(a)},INPUT:function(a){_.isString(a)||(a=JSON.stringify(a));var c=b.dom(d).get(0).type;_.contains(["text","password"],c)&&b.dom(d).val(a||""),_.contains(["checkbox","radio"],c)&&(a===b.dom(d).val()?b.dom(d).prop("checked",!0):b.dom(d).prop("checked",!1))},TEXTAREA:function(a){_.isString(a)||(a=JSON.stringify(a)),b.dom(d).val(a||"")},PRE:function(a){c.html?b.dom(d).html(a):b.dom(d).text(a)},IMG:function(a){if(!a)return a=c.default||"",b.dom(d).attr("src",a),!1;var e=function(a,c){b.dom(d).addClass("way-loading"),b.dom("img",{src:a,onerror:function(){c(!1)},onload:function(){c(!0)}})};e(a,function(e){b.dom(d).removeClass("way-loading"),e?b.dom(d).removeClass("way-error").addClass("way-success"):(a?b.dom(d).addClass("way-error"):b.dom(d).removeClass("way-error").removeClass("way-success"),a=c.default||""),b.dom(d).attr("src",a)})}},g=function(a){c.html?b.dom(d).html(a):b.dom(d).text(a)},h=b.dom(d).get(0).tagName,i=f[h]||g;i(a)},e.prototype.setDefault=function(a,b,c){var d=this,c=c||d._element,a=a||!1,b=b?_.extend(d.dom(c).getOptions(),b):d.dom(c).getOptions();return b.default?void(a?d.set(b.data,b.default,b):d.dom(c).setValue(b.default,b)):!1},e.prototype.setDefaults=function(){var a=this,d="["+c+"-default]",e=b.dom(d).get();for(var f in e){var g=e[f],h=a.dom(g).getOptions(),i=h.data||null,j=i?a.get(i):null;j||a.dom(g).setDefault()}},e.prototype.registerBindings=function(){var a=this,d="["+c+"-data]";a._bindings={};var e=b.dom(d).get();for(var f in e){var g=e[f],h=a.dom(g).getOptions(),i=a.dom(g).scope(),d=i?i+"."+h.data:h.data;a._bindings[d]=a._bindings[d]||[],_.contains(a._bindings[d],b.dom(g).get(0))||a._bindings[d].push(b.dom(g).get(0))}},e.prototype.updateBindings=function(a){var c=this;c._bindings=c._bindings||{};var d=k(c._bindings,a);d.forEach(function(a){var d=b.dom(a).get(0)===b.dom(":focus").get(0)?!0:!1;d||c.dom(a).fromStorage()}),c._bindings.__all__&&c._bindings.__all__.forEach(function(a){c.dom(a).fromJSON(c.data)})},e.prototype.registerRepeats=function(){var a=this,d="["+c+"-repeat]";a._repeats=a._repeats||{},a._repeatsCount=a._repeatsCount||0;var e=b.dom(d).get();for(var f in e){var g=e[f],h=a.dom(g).getOptions();a._repeats[h.repeat]=a._repeats[h.repeat]||[];var i=c+'-repeat-wrapper="'+a._repeatsCount+'"',j=b.dom(g).parent("["+i+"]");if(!j.length){a._repeats[h.repeat].push({id:a._repeatsCount,element:b.dom(g).clone(!0).removeAttr(c+"-repeat").get(0),selector:h.repeat});var k=document.createElement("div");b.dom(k).attr(c+"-repeat-wrapper",a._repeatsCount),b.dom(k).attr(c+"-scope",h.repeat),b.dom(g).replaceWith(k),a.updateRepeats(h.repeat),a._repeatsCount++}}},e.prototype.updateRepeats=function(a){var d=this;d._repeats=d._repeats||{};var e=k(d._repeats,a);e.forEach(function(a){var e="["+c+'-repeat-wrapper="'+a.id+'"]',f=d.get(a.selector),g=[];b.dom(e).empty();for(var h in f){b.dom(a.element).attr(c+"-scope",h);var i=b.dom(a.element).get(0).outerHTML;i=i.replace(/\$\$key/gi,h),g.push(i)}b.dom(e).html(g),d.registerBindings(),d.updateBindings()})},e.prototype.updateForms=function(){var a=this,d="form["+c+"-data]",e=b.dom(d).get();for(var f in e){var h=e[f],i=a.dom(h).getOptions(),j=i.data;b.dom(h).removeAttr(c+"-data");var k=b.dom(h).find("[name]").reverse().get();for(var f in k){var l=k[f],m=b.dom(l).attr("name");if(g(m,"[]")){var n=m.split("[]")[0],o="[name^='"+n+"']",p=b.dom(h).find(o).get().length;m=n+"."+p}var d=j+"."+m;i.data=d,a.dom(l).setOptions(i),b.dom(l).removeAttr("name")}}},e.prototype.registerDependencies=function(){this.registerBindings(),this.registerRepeats()},e.prototype.updateDependencies=function(a){this.updateBindings(a),this.updateRepeats(a),this.updateForms(a)},e.prototype.setOptions=function(a,d){var e=this,d=e._element||d;for(var f in a){var g=c+"-"+f,h=a[f];b.dom(d).attr(g,h)}},e.prototype.getOptions=function(a){var b=this,a=a||b._element,d={data:null,html:!1,readonly:!1,writeonly:!1,persistent:!1};return _.extend(d,b.dom(a).getAttrs(c))},e.prototype.getAttrs=function(a,c){var d=this,c=c||d._element,e=function(a,b){var c={pick:"array",omit:"array",readonly:"boolean",writeonly:"boolean",json:"boolean",html:"boolean",persistent:"boolean"},d={array:function(a){return a.split(",")},"boolean":function(a){return"true"===a?!0:"false"===a?!1:!0}},e=function(){return b},f=c[a]||null,g=d[f]||e;return g(b)},g={},h=b.dom(c).get(0).attributes;for(var i in h){var j=h[i],k=a&&f(j.name,a+"-")?!0:!1;if(k){var l=a?j.name.slice(a.length+1,j.name.length):j.name,m=e(l,j.value);g[l]=m}}return g},e.prototype.scope=function(a,d){var e=this,d=d||e._element,f=c+"-scope",g=c+"-scope-break",h=[],i="",j="["+g+"], ["+f+"]",k=b.dom(d).parents(j).get();for(var l in k){var m=k[l];if(b.dom(m).attr(g))break;var n=b.dom(m).attr(f);h.unshift(n)}return b.dom(d).attr(f)&&h.push(b.dom(d).attr(f)),b.dom(d).attr(g)&&(h=[]),i=h.join(".")},e.prototype.get=function(a){var b=this;return void 0===a||_.isString(a)?b.data?a?_json.get(b.data,a):b.data:{}:!1},e.prototype.set=function(a,b,c){if(!a)return!1;if("this"===a.split(".")[0])return console.log('Sorry, "this" is a reserved word in way.js'),!1;var d=this;if(c=c||{},a){if(!_.isString(a))return!1;d.data=d.data||{},d.data=a?_json.set(d.data,a,b):{},d.updateDependencies(a),d.emitChange(a,b),c.persistent&&d.backup(a)}},e.prototype.push=function(a,b,c){if(!a)return!1;var d=this;c=c||{},a&&(d.data=a?_json.push(d.data,a,b,!0):{}),d.updateDependencies(a),d.emitChange(a,null),c.persistent&&d.backup(a)},e.prototype.remove=function(a,b){var c=this;b=b||{},c.data=a?_json.remove(c.data,a):{},c.updateDependencies(a),c.emitChange(a,null),b.persistent&&c.backup(a)},e.prototype.clear=function(){this.remove(null,{persistent:!0})},e.prototype.backup=function(){var a=this;if(a.options.persistent)try{var b=a.data||{};localStorage.setItem(c,JSON.stringify(b))}catch(d){console.log("Your browser does not support localStorage.")}},e.prototype.restore=function(){var a=this;if(a.options.persistent)try{var b=localStorage.getItem(c);try{b=JSON.parse(b);for(var d in b)a.set(d,b[d])}catch(e){}}catch(e){console.log("Your browser does not support localStorage.")}};var f=function(a,b){return""===b?!0:null===a||null===b?!1:(a=String(a),b=String(b),a.length>=b.length&&a.slice(0,b.length)===b)},g=function(a,b){return""===b?!0:null===a||null===b?!1:(a=String(a),b=String(b),a.length>=b.length&&a.slice(a.length-b.length,a.length)===b)},h=function(a){return _.pick(a,_.compact(_.keys(a)))},i=function(a,b,c){var d=_.keys(a);return d.forEach(function(d){c?f(d,b)||delete a[d]:f(d,b)&&delete a[d]}),a},j=function(a,b,c){var d=_json.flatten(a);for(var e in b)d=i(d,b[e],c);var f=_json.unflatten(d);return h(f)},k=function(a,b){var c=[];if(b){var d=b.split("."),e=d[d.length-1],g=!isNaN(e);if(g){d.pop();var h=d.join(".");c=a[h]?_.union(c,a[h]):c}for(var h in a)f(h,b)&&(c=_.union(c,a[h]))}else for(var h in a)c=_.union(c,a[h]);return c},l=function(a){return a?a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"):a},m=function(){};m.constructor=m,m.prototype.dom=function(a,b){var c=this,d=[];if(!b)return _.isString(a)?d=[].slice.call(document.querySelectorAll(a)):_.isObject(a)&&a.attributes&&(d=[a]),c._elements=d,c.length=d.length,c;var e=document.createElement(a);for(var f in b)e[f]=b[f]},m.prototype.on=function(a,b){var c=this,d=c._elements;a=a.split(" ");for(var e=0,f=d.length;f>e;e++)for(var g=d[e],h=0,i=a.length;i>h;h++)g.addEventListener&&g.addEventListener(a[h],b,!1)},m.prototype.find=function(a){var b=this,c=b.get(0),d=[];return _.isString(a)&&(d=[].slice.call(c.querySelectorAll(a))),b._elements=d,b},m.prototype.get=function(a,b){var c=this,d=c._elements||[],e=d[a]||{};return b?(c._element=e,c):_.isNumber(a)?e:d},m.prototype.reverse=function(){return this._elements=this._elements.reverse(),this},m.prototype.val=function(a){return this.prop("value",a)},m.prototype.type=function(a){return this.prop("type",a)},m.prototype.html=function(a){return this.prop("innerHTML",a)},m.prototype.text=function(a){return this.prop("innerHTML",l(a))},m.prototype.prop=function(a,b){var c=this,d=c._elements;for(var e in d){if(_.isUndefined(b))return d[e][a];d[e][a]=b}},m.prototype.attr=function(a,b){var c=this,d=c._elements;for(var e in d){if(void 0===b)return d[e].getAttribute(a);d[e].setAttribute(a,b)}return c},m.prototype.removeAttr=function(a){var b=this;for(var c in b._elements)b._elements[c].removeAttribute(a);return b},m.prototype.addClass=function(a){var b=this;for(var c in b._elements)b._elements[c].classList.add(a);return b},m.prototype.removeClass=function(a){var b=this;for(var c in b._elements)b._elements[c].classList.remove(a);return b},m.prototype.parents=function(a){for(var b=this,c=b.get(0),d=c.parentNode,e=[];null!==d;){var f=d,g=a&&f.matches?f.matches(a):!0,h=void 0!==f.doctype?!0:!1;g&&!h&&e.push(f),d=f.parentNode}return b._elements=e,b},m.prototype.parent=function(a){var b=this,c=b.get(0),d=c.parentNode,e=a?d.matches(a):!0;return e?d:{}},m.prototype.clone=function(a){var b=this,c=b.get(0),d=c.cloneNode(!0);return b._elements=[d],a?b:d},m.prototype.empty=function(a){var b=this,c=b.get(0);if(!c||!c.hasChildNodes)return a?b:c;for(;c.hasChildNodes();)c.removeChild(c.lastChild);return a?b:c},m.prototype.replaceWith=function(a){var b=this,c=b.get(0),d=c.parentNode;d.replaceChild(a,c)},m.prototype.ready=function(a){document.onreadystatechange=function(){"complete"===document.readyState&&a()}},a=new e;var n=null,o=function(c){n&&clearTimeout(n),n=setTimeout(function(){var d=b.dom(c.target).get(0);a.dom(d).toStorage()},a.options.timeout)},p=function(b){b.preventDefault();var c=a.dom(this).getOptions();a.remove(c.data,c)},q=function(b){b.preventDefault();var c=a.dom(this).getOptions();if(!c||!c["action-push"])return!1;var d=c["action-push"].split(":"),e=d[0]||null,f=d[1]||null;a.push(e,f,c)},r=function(b){b.preventDefault();var c=a.dom(this).getOptions();return c&&c["action-remove"]?void a.remove(c["action-remove"],c):!1},s=null,t=function(){s&&clearTimeout(s),s=setTimeout(function(){a.registerDependencies(),u()},a.options.timeoutDOM)};b=new m;var u=function(){b.dom("body").on("DOMSubtreeModified",t),b.dom("["+c+"-data]").on("input change",o),b.dom("["+c+"-clear]").on("click",p),b.dom("["+c+"-action-remove]").on("click",r),b.dom("["+c+"-action-push]").on("click",q)},v=function(){u(),a.restore(),a.setDefaults(),a.registerDependencies(),a.updateDependencies()};return b.ready(v),a});