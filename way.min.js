!function(a){"use strict";var b,c,d="way",e=function(){this._watchers={},this._watchersAll={}};e.prototype.constructor=e,e.prototype.watchAll=function(a){this._watchersAll=this._watchersAll||[],_.contains(this._watchersAll,a)||this._watchersAll.push(a)},e.prototype.watch=function(a,b){this._watchers||(this._watchers={}),this._watchers[a]=this._watchers[a]||[],this._watchers[a].push(b)},e.prototype.findWatcherDeps=function(a){var b=[],c=_.keys(this._watchers);return c.forEach(function(c){g(a,c)&&b.push(c)}),b},e.prototype.emitChange=function(a){this._watchers||(this._watchers={});var b=this,c=b.findWatcherDeps(a);c.forEach(function(a){this._watchers[a]&&this._watchers[a].forEach(function(c){c.apply(b,[b.get(a)])})}),b._watchersAll&&_.isArray(b._watchersAll)&&b._watchersAll.forEach(function(c){_.isFunction(c)&&c.apply(b,[a,b.get(a)])})};var f=function(){this.data={},this._bindings={},this.options={persistent:!0,timeoutInput:50,timeoutDOM:500}};f.prototype=Object.create(e.prototype),f.constructor=f,f.prototype.dom=function(a){return this._element=c.dom(a).get(0),this},f.prototype.toStorage=function(a,b){var c=this,b=b||c._element,a=a||c.dom(b).getOptions(),d=c.dom(b).toJSON(a),e=c.dom(b).scope(),f=e?e+"."+a.data:a.data;return a.readonly?!1:void c.set(f,d,a)},f.prototype.toJSON=function(a,b){var c=this,b=b||c._element,d=c.dom(b).getValue(),a=a||c.dom(b).getOptions();return _.isArray(a.pick)&&(d=k(d,a.pick,!0)),_.isArray(a.omit)&&(d=k(d,a.omit,!1)),d},f.prototype.fromStorage=function(a,b){var c=this,b=b||c._element,a=a||c.dom(b).getOptions();if(a.writeonly)return!1;var d=c.dom(b).scope(),e=d?d+"."+a.data:a.data,f=c.get(e);c.dom(b).fromJSON(f,a)},f.prototype.fromJSON=function(a,b,c){var d=this,c=c||d._element,b=b||d.dom(c).getOptions();if(b.writeonly)return!1;if(_.isObject(a)){_.isArray(b.pick)&&(a=k(a,b.pick,!0)),_.isArray(b.omit)&&(a=k(a,b.omit,!1));var e=_.isObject(d.dom(c).toJSON())?d.dom(c).toJSON():{};a=_.extend(e,a)}b.json&&(a=_json.isStringified(a)?a:_json.prettyprint(a)),d.dom(c).setValue(a,b)},f.prototype.getValue=function(a){var b=this,a=a||b._element,d={SELECT:function(){return c.dom(a).val()},INPUT:function(){var b=c.dom(a).type();return _.contains(["text","password"],b)?c.dom(a).val():_.contains(["checkbox","radio"],b)?c.dom(a).prop("checked")?c.dom(a).val():null:void 0},TEXTAREA:function(){return c.dom(a).val()}},e=function(){c.dom(a).html()},f=c.dom(a).get(0).tagName,g=d[f]||e;return g()},f.prototype.setValue=function(a,b,d){var e=this,d=d||e._element,b=b||e.dom(d).getOptions(),f={SELECT:function(a){c.dom(d).val(a)},INPUT:function(a){_.isString(a)||(a=JSON.stringify(a));var b=c.dom(d).get(0).type;_.contains(["text","password"],b)&&c.dom(d).val(a||""),_.contains(["checkbox","radio"],b)&&(a==c.dom(d).val()?c.dom(d).prop("checked",!0):c.dom(d).prop("checked",!1))},TEXTAREA:function(a){_.isString(a)||(a=JSON.stringify(a)),c.dom(d).val(a||"")},PRE:function(a){b.html?c.dom(d).html(a):c.dom(d).text(a)},IMG:function(a){if(!a)return a=b.default||"",c.dom(d).attr("src",a),!1;var e=function(a,b){c.dom(d).addClass("way-loading"),c.dom("img",{src:a,onerror:function(){b(!1)},onload:function(){b(!0)}})};e(a,function(e){c.dom(d).removeClass("way-loading"),e?c.dom(d).removeClass("way-error").addClass("way-success"):(a?c.dom(d).addClass("way-error"):c.dom(d).removeClass("way-error").removeClass("way-success"),a=b.default||""),c.dom(d).attr("src",a)})}},g=function(a){b.html?c.dom(d).html(a):c.dom(d).text(a)},h=c.dom(d).get(0).tagName,i=f[h]||g;i(a)},f.prototype.setDefault=function(a,b,c){var d=this,c=c||d._element,a=a||!1,b=b?_.extend(d.dom(c).getOptions(),b):d.dom(c).getOptions();return b.default?void(a?d.set(b.data,b.default,b):d.dom(c).setValue(b.default,b)):!1},f.prototype.setDefaults=function(){var a=this,b="["+d+"-default]",e=c.dom(b).get();for(var f in e){var g=e[f],h=a.dom(g).getOptions(),i=h.data||null,j=i?a.get(i):null;j||a.dom(g).setDefault()}},f.prototype.registerBindings=function(){var a=this,b="["+d+"-data]";a._bindings={};var e=c.dom(b).get();for(var f in e){var g=e[f],h=a.dom(g).getOptions(),i=a.dom(g).scope(),b=i?i+"."+h.data:h.data;a._bindings[b]=a._bindings[b]||[],_.contains(a._bindings[b],c.dom(g).get(0))||a._bindings[b].push(c.dom(g).get(0))}},f.prototype.updateBindings=function(a){var b=this;b._bindings=b._bindings||{};var d=l(b._bindings,a);d.forEach(function(a){var d=c.dom(a).get(0)==c.dom(":focus").get(0)?!0:!1;d||b.dom(a).fromStorage()}),b._bindings.__all__&&b._bindings.__all__.forEach(function(a){b.dom(a).fromJSON(b.data)})},f.prototype.registerRepeats=function(){var a=this,b="["+d+"-repeat]";a._repeats=a._repeats||{},a._repeatsCount=a._repeatsCount||0;var e=c.dom(b).get();for(var f in e){var g=e[f],h=a.dom(g).getOptions();a._repeats[h.repeat]=a._repeats[h.repeat]||[];var i=d+'-repeat-wrapper="'+a._repeatsCount+'"',j=c.dom(g).parent("["+i+"]");if(!j.length){a._repeats[h.repeat].push({id:a._repeatsCount,element:c.dom(g).clone(!0).removeAttr(d+"-repeat").get(0),selector:h.repeat});var k=document.createElement("div");c.dom(k).attr(d+"-repeat-wrapper",a._repeatsCount),c.dom(k).attr(d+"-scope",h.repeat),c.dom(g).replaceWith(k),a.updateRepeats(h.repeat),a._repeatsCount++}}},f.prototype.updateRepeats=function(a){var b=this;b._repeats=b._repeats||{};var e=l(b._repeats,a);e.forEach(function(a){var e="["+d+"-repeat-wrapper='"+a.id+"']",f=b.get(a.selector),g=[];c.dom(e).empty();for(var h in f){c.dom(a.element).attr(d+"-scope",h);var i=c.dom(a.element).get(0).outerHTML;i=i.replace(/\$\$key/gi,h),g.push(i)}c.dom(e).html(g),b.registerBindings(),b.updateBindings()})},f.prototype.updateForms=function(){var a=this,b="form["+d+"-data]",e=c.dom(b).get();for(var f in e){var g=e[f],i=a.dom(g).getOptions(),j=i.data;c.dom(g).removeAttr(d+"-data");var k=c.dom(g).find("[name]").reverse().get();for(var f in k){var l=k[f],m=c.dom(l).attr("name");if(h(m,"[]")){var n=m.split("[]")[0],o="[name^='"+n+"']",p=c.dom(g).find(o).get().length;m=n+"."+p}var b=j+"."+m;i.data=b,a.dom(l).setOptions(i),c.dom(l).removeAttr("name")}}},f.prototype.registerDependencies=function(){this.registerBindings(),this.registerRepeats()},f.prototype.updateDependencies=function(a){this.updateBindings(a),this.updateRepeats(a),this.updateForms(a)},f.prototype.setOptions=function(a,b){var e=this,b=e._element||b;for(var f in a){var g=d+"-"+f,h=a[f];c.dom(b).attr(g,h)}},f.prototype.getOptions=function(a){var b=this,a=a||b._element,c={data:null,html:!1,readonly:!1,writeonly:!1,persistent:!1};return _.extend(c,b.dom(a).getAttrs(d))},f.prototype.getAttrs=function(a,b){var d=this,b=b||d._element,e=function(a,b){var c={pick:"array",omit:"array",readonly:"boolean",writeonly:"boolean",json:"boolean",html:"boolean",persistent:"boolean"},d={array:function(a){return a.split(",")},"boolean":function(a){return"true"==a?!0:"false"==a?!1:!0}},e=function(){return b},f=c[a]||null,g=d[f]||e;return g(b)},f={},h=c.dom(b).get(0).attributes;for(var i in h){var j=h[i],k=a&&g(j.name,a+"-")?!0:!1;if(k){var l=a?j.name.slice(a.length+1,j.name.length):j.name,m=e(l,j.value);f[l]=m}}return f},f.prototype.scope=function(a,b){var e=this,b=b||e._element,f=d+"-scope",g=d+"-scope-break",h=[],i="",j="["+g+"], ["+f+"]",k=c.dom(b).parents(j).get();for(var l in k){var m=k[l];if(c.dom(m).attr(g))break;var n=c.dom(m).attr(f);h.unshift(n)}return c.dom(b).attr(f)&&h.push(c.dom(b).attr(f)),c.dom(b).attr(g)&&(h=[]),i=h.join(".")},f.prototype.get=function(a){var b=this;return void 0==a||_.isString(a)?b.data?a?_json.get(b.data,a):b.data:{}:!1},f.prototype.set=function(a,b,c){if(!a)return!1;if("this"===a.split(".")[0])return console.log('Sorry, "this" is a reserved word in way.js'),!1;var d=this;if(c=c||{},a){if(!_.isString(a))return!1;d.data=d.data||{},d.data=a?_json.set(d.data,a,b):{},d.updateDependencies(a),d.emitChange(a,b),c.persistent&&d.backup(a)}},f.prototype.push=function(a,b,c){if(!a)return!1;var d=this;c=c||{},a&&(d.data=a?_json.push(d.data,a,b,!0):{}),d.updateDependencies(a),d.emitChange(a,null),c.persistent&&d.backup(a)},f.prototype.remove=function(a,b){var c=this;b=b||{},c.data=a?_json.remove(c.data,a):{},c.updateDependencies(a),c.emitChange(a,null),b.persistent&&c.backup(a)},f.prototype.clear=function(){this.remove(null,{persistent:!0})},f.prototype.backup=function(){var a=this;if(a.options.persistent)try{var b=a.data||{};localStorage.setItem(d,JSON.stringify(b))}catch(c){console.log("Your browser does not support localStorage.")}},f.prototype.restore=function(){var a=this;if(a.options.persistent)try{var b=localStorage.getItem(d);try{b=JSON.parse(b);for(var c in b)a.set(c,b[c])}catch(e){}}catch(e){console.log("Your browser does not support localStorage.")}};var g=function(a,b){return""===b?!0:null==a||null==b?!1:(a=String(a),b=String(b),a.length>=b.length&&a.slice(0,b.length)===b)},h=function(a,b){return""===b?!0:null==a||null==b?!1:(a=String(a),b=String(b),a.length>=b.length&&a.slice(a.length-b.length,a.length)===b)},i=function(a){return _.pick(a,_.compact(_.keys(a)))},j=function(a,b,c){var d=_.keys(a);return d.forEach(function(d){c?g(d,b)||delete a[d]:g(d,b)&&delete a[d]}),a},k=function(a,b,c){var d=_json.flatten(a);for(var e in b)d=j(d,b[e],c);var f=_json.unflatten(d);return i(f)},l=function(a,b){var c=[];if(b){var d=b.split("."),e=d[d.length-1],f=!isNaN(e);if(f){d.pop();var h=d.join(".");c=a[h]?_.union(c,a[h]):c}for(var h in a)g(h,b)&&(c=_.union(c,a[h]))}else for(var h in a)c=_.union(c,a[h]);return c},m=function(a){return a?a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"):a},n=function(){};n.constructor=n,n.prototype.dom=function(a,b){var c=this,d=[];if(!b)return _.isString(a)?d=[].slice.call(document.querySelectorAll(a)):_.isObject(a)&&a.attributes&&(d=[a]),c._elements=d,c.length=d.length,c;var e=document.createElement(a);for(var f in b)e[f]=b[f]},n.prototype.on=function(a,b){var c=this,d=c._elements;a=a.split(" ");for(var e=0,f=d.length;f>e;e++)for(var g=d[e],h=0,i=a.length;i>h;h++)g.addEventListener&&g.addEventListener(a[h],b,!1)},n.prototype.find=function(a){var b=this,c=b.get(0),d=[];return _.isString(a)&&(d=[].slice.call(c.querySelectorAll(a))),b._elements=d,b},n.prototype.get=function(a,b){var c=this,d=c._elements||[],e=d[a]||{};return b?(c._element=e,c):_.isNumber(a)?e:d},n.prototype.reverse=function(){return this._elements=this._elements.reverse(),this},n.prototype.val=function(a){return this.prop("value",a)},n.prototype.type=function(a){return this.prop("type",a)},n.prototype.html=function(a){return this.prop("innerHTML",a)},n.prototype.text=function(a){return this.prop("innerHTML",m(a))},n.prototype.prop=function(a,b){var c=this,d=c._elements;for(var e in d){if(_.isUndefined(b))return d[e][a];d[e][a]=b}},n.prototype.attr=function(a,b){var c=this,d=c._elements;for(var e in d){if(void 0==b)return d[e].getAttribute(a);d[e].setAttribute(a,b)}return c},n.prototype.removeAttr=function(a){var b=this;for(var c in b._elements)b._elements[c].removeAttribute(a);return b},n.prototype.addClass=function(a){var b=this;for(var c in b._elements)b._elements[c].classList.add(a);return b},n.prototype.removeClass=function(a){var b=this;for(var c in b._elements)b._elements[c].classList.remove(a);return b},n.prototype.parents=function(a){for(var b=this,c=b.get(0),d=c.parentNode,e=[];null!==d;){var f=d,g=a&&f.matches?f.matches(a):!0,h=void 0!=f.doctype?!0:!1;g&&!h&&e.push(f),d=f.parentNode}return b._elements=e,b},n.prototype.parent=function(a){var b=this,c=b.get(0),d=c.parentNode,e=a?d.matches(a):!0;return e?d:{}},n.prototype.clone=function(a){var b=this,c=b.get(0),d=c.cloneNode(!0);return b._elements=[d],a?b:d},n.prototype.empty=function(a){var b=this,c=b.get(0);if(!c||!c.hasChildNodes)return a?b:c;for(;c.hasChildNodes();)c.removeChild(c.lastChild);return a?b:c},n.prototype.replaceWith=function(a){var b=this,c=b.get(0),d=c.parentNode;d.replaceChild(a,c)},n.prototype.ready=function(a){document.onreadystatechange=function(){"complete"==document.readyState&&a()}},b=new f;var o=null,p=function(a){o&&clearTimeout(o),o=setTimeout(function(){var d=c.dom(a.target).get(0);b.dom(d).toStorage()},b.options.timeout)},q=function(a){a.preventDefault();var c=b.dom(this).getOptions();b.remove(c.data,c)},r=function(a){a.preventDefault();var c=b.dom(this).getOptions();if(!c||!c["action-push"])return!1;var d=c["action-push"].split(":"),e=d[0]||null,f=d[1]||null;b.push(e,f,c)},s=function(a){a.preventDefault();var c=b.dom(this).getOptions();return c&&c["action-remove"]?void b.remove(c["action-remove"],c):!1},t=null,u=function(){t&&clearTimeout(t),t=setTimeout(function(){b.registerDependencies(),v()},b.options.timeoutDOM)};c=new n;var v=function(){c.dom("body").on("DOMSubtreeModified",u),c.dom("["+d+"-data]").on("input change",p),c.dom("["+d+"-clear]").on("click",q),c.dom("["+d+"-action-remove]").on("click",s),c.dom("["+d+"-action-push]").on("click",r)},w=function(){v(),b.restore(),b.setDefaults(),b.registerDependencies(),b.updateDependencies()};c.ready(w),a.way=b}(this);